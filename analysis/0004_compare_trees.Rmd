---
title: "0004 Compare Trees"
author: "Dan MacLean"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

We wish to compare the species clustering from the heatmap in `0001_heatmap_development.Rmd` with the species tree as generated by Orthofinder

## Load heatmap dendro

The tree from the kmeans clustered summary heatmap

```{r}
library(ape)
library(dendextend)
hmap_tree <- readRDS(here::here("results", "heatmap_species_dendro.RDS")) |> 
  as.phylo()
```

## Load orthofinder species tree

Species tree calculated by orthofinder. We will need to fix the names here, orthofinder used the short tags.

```{r}
orthof_tree <- read.tree(here::here("results", "SpeciesTree_rooted.txt"))

info <- readr::read_csv(here::here("lib", "all_proteomes_lifestyles.csv")) |> 
  dplyr::select(name, tag)

info_vec <- info$name
names(info_vec) <- info$tag

for (i in 1:length(orthof_tree$tip.label)) {
  orthof_tree$tip.label[i] <- info_vec[orthof_tree$tip.label[i]]
}

```


## Quick comparison

Generate a quick comparison summary and plot


```{r, fig.height=12, fig.width=12}
cf <- comparePhylo(hmap_tree, orthof_tree, plot=TRUE)
cf
```


## Plot again

A clear, unadorned plot.


```{r, fig.height=9, fig.width=9}
library(ggtree)
library(ggtreeExtra)

ggtree(hmap_tree) + geom_tiplab(as_ylab = TRUE)
ggtree(orthof_tree) + geom_tiplab(as_ylab = TRUE)
```


## Render some annotation on to the tree

See whether we can plot any data (like proportion of phos sites found) on to the tree, as this may be a useful summary plot type for the heatmap and annotation data.


Part 1, prep the annotation data

```{r}
library(here)
library(readr)
library(dplyr)
library(ggplot2)
library(tidyr)

df <- read_csv(here("results/merged_test_sites.csv"),
               col_types = cols(
                 phos_site_id = col_character(),
                 mo_protein_id = col_character(),
                 species_compared = col_character(),
                 has_ortholog = col_logical(),
                 best_hit_ortholog = col_character(),
                 has_hit_in_ortholog = col_logical(),
                 best_hit_ortholog_score = col_double(),
                 best_hit_ortholog_identity = col_character(),
                 num_p_sites_in_mo = col_integer(),
                 num_sites_matched_in_ortholog = col_integer(),
                 sites_found_in_ortho = col_integer(),
                 mo_peptide = col_character(),
                 mo_seq_in_hit = col_character(),
                 orth_seq_in_hit = col_character(),
                 annotated_seq = col_character(),
                 mod_pattern = col_character()
               )
                 
               ) |> 
  transmute(phos_site_id, mo_protein_id, species_compared, has_ortholog, best_hit_ortholog, num_p_sites_in_mo, num_sites_matched_in_ortholog, prop_found = 100 * num_sites_matched_in_ortholog / num_p_sites_in_mo)
  

trophism_info <- readr::read_csv(here("lib", "all_proteomes_lifestyles.csv"))  |> rename("Saprotroph"="Saprophyte") |> 
  select( name, tag, Saprotroph, Endophyte, Symbiont, Commensal,Biotroph, Hemibiotroph, Necrotroph) |> 
  filter(tag != "Mo8") |> 
  pivot_longer(cols = c(Saprotroph, Endophyte, Symbiont, Commensal,Biotroph, Hemibiotroph, Necrotroph),names_to = "trophism", values_to = "trophism_val") |> 
  group_by(trophism, tag) |> 
  filter(trophism_val == TRUE) |> 
  summarise( trophism = first(trophism)
             ) |> 
  arrange(tag)

appressorium_info <- readr::read_csv(here("lib", "all_proteomes_lifestyles.csv"))  |> 
  rename("Hyaline" = "Hyaline Appressorium", "Compound"="compound appressorium", "Melanized"="Melanized Appressorium","None"="No appressorium") |>
  select( name, tag, "Compound", "Hyaline", "Melanized", "None") |>
  filter(tag != "Mo8") |> 
  pivot_longer(cols = c("Compound", "Hyaline", "Melanized", "None"), names_to = "appressorium", values_to = "appressorium_val") |> 
  group_by(appressorium, tag) |> 
  filter(appressorium_val == TRUE) |> 
  summarise( appressorium = first(appressorium),
             name = name) |> 
  arrange(tag)

pmk1_info <- readr::read_csv(here("lib", "all_proteomes_lifestyles.csv"))  |> 
  rename("pmk1_path"="Pmk1 pathogenicity") |>
  filter(tag != "Mo8") |> 
  mutate("pmk1_path" = if_else(pmk1_path, "PMK1 Required", "PMK1 Not Required")) |> 
  select( tag, "pmk1_path" )


df <- left_join(df, appressorium_info, by = c("species_compared"="tag"))  |> 
  left_join(trophism_info,by = c("species_compared"="tag" )) |> 
  left_join(pmk1_info, by = c("species_compared"="tag")) 

clus <- read_csv(here("analysis/cluster_gene_info.csv")) |> 
  select(phos_site_id, cluster_number) |> 
  unique() |> 
  filter(! is.na(cluster_number))

df <- left_join(df, clus) |> unique()

```





Part 2, plot it onto the tree


```{r, fig.width=9, fig.height=9}
p <- ggtree(hmap_tree, layout="circular")


cluster_order <- c(4,9,6,3,5,2,1,7,8)

for (i in cluster_order) {
 small_df <- df |> filter(cluster_number == i)
 p <- p + geom_fruit(
  data=small_df,
  geom=geom_violin,
  mapping=aes(x=prop_found, y=name, fill = as.factor(cluster_number) ),
      axis.params=list(
                         axis       = "x",
                         text.size  = 1.8,
                         hjust      = 1,
                         vjust      = 0.5,
                         nbreak     = 2,
                     ),
  offset = 0.1,
  na.rm=TRUE
)
}    


p + geom_fruit(
  data = appressorium_info,
  geom=geom_tile,
  mapping = aes(x=appressorium, y=name, fill=appressorium)
) 



```

Well, it plotted, but it isnt very readable. 

