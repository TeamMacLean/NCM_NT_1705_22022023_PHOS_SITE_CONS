---
title: "0005 High Quality Figure"
author: "Dan MacLean"
date: "`r Sys.Date()`"
output: html_document
---


Frank would like a high quality version of the figure for publications.

This document relies on previous analysis:

We need -

  * `results/kmeans.RDS` from `0001_heatmap_development.Rmd`
  * `results/heatmap_species_dendro.RDS`  the tree object from the heatmap of that kmeans,from `0001_heatmap_development.Rmd`
  * `results/counts_in_outside_clusters.csv` counts of clusters from another experiment, from `0001_heatmap_development.Rmd`

These will be incorporated as needed. 


We want to make a large heatmap in many panels so we'll try using geom_tile on the kmeans object to start with

```{r}
library(ggplot2)



species_order <- c("C.higginsianum", "C.fructicola", "C.gloeosporioides",
                "V.mali", "C.chrysosperma", "V.dahliae", 
                "N.crassa", "C.purpurea", "F.oxysporum-C.alt",
                "F.oxysporum-5176", "F.verticillioides", "F.oxysporum-2",
                "F.graminearum", "B.cinerea", "S.sclerotiorum",
                "U.virens", "P.oxalicum", "A.fumigatus", "A.flavus",
                "A.nidulans", "H.capsulatum", "B.graminis", "Z.tritici",
                "B.sorokiniana", "B.oryzae","C.heterostrophus", "S.turcica",
                "P.teres", "A.alternata", "S.nodorum","A.brassicicola",
                "P.pachyrhizi", "S.cerevisiae", "U.maydis","C.neoformans",
                "P.striiformis", "P.graminis", "R.irregularis", "C.albicans",
                "P.indica", "S.pombe")
cluster_order <- c(4,9,6,3,5,2,1,7,8)

km <- readRDS(here::here("results","kmeans.RDS"))
km_df <- tibble::as_tibble(km$centers, rownames = "cluster") |> 
  tidyr::pivot_longer(cols = !cluster, names_to = "name", values_to = "centre") |> 
  dplyr::mutate(
    name = factor(name, level=rev(species_order)),
    cluster = factor(cluster, level=rev(cluster_order))
    )



hmap <- ggplot(km_df) + 
  aes(cluster, name) +
  geom_tile(aes(fill=centre)) + 
  scale_fill_gradientn(colours = c("gray", "white", "#FDE725FF", "#238A8DFF",  "#440154FF"),
                         values = c(-1,0,0.33, 0.50, 1.00), name="% target phos-sites found") +
  theme_minimal()

hmap
```
We have the basic heatmap. Next we need the lifestyle info as separate column heatmaps. 

```{r}

lifestyle_info <- readr::read_csv(here::here("lib/all_proteomes_lifestyles.csv"))

app_hmap <- lifestyle_info |> dplyr::select(name, dplyr::ends_with("orium")) |> 
  tidyr::pivot_longer(-name, names_to = "AppressoriumType", values_to = "Appressorium") |>
  dplyr::filter(Appressorium, name !="M.oryzae") |> 
  dplyr::mutate(
      AppressoriumType = dplyr::if_else(AppressoriumType == "compound appressorium", "Hyaline Appressorium", AppressoriumType),
      name = factor(name, level=rev(species_order)),
  ) |> 
  ggplot() + 
  aes(Appressorium, name) +
  geom_tile(aes(fill=AppressoriumType)) +
  scale_fill_manual(values = c("pink", "brown", "gray"),
                    labels = c("Hyaline", "Melanized", "None"), name="Appressorium") +
  
  theme_minimal()

life_hmap <- lifestyle_info |> dplyr::select(name, dplyr::ends_with(c("oph", "phyte", "ont", "sal", "gen")) ) |> 
  tidyr::pivot_longer(-name, names_to = "LifestyleType", values_to = "Lifestyle") |>
  dplyr::filter(Lifestyle, name !="M.oryzae") |> 
  dplyr::mutate(
      name = factor(name, level=rev(species_order)),
  ) |> 
  ggplot() + 
  aes(Lifestyle, name) +
  geom_tile(aes(fill=LifestyleType)) +
  scale_fill_manual(values =  c("#b2df8a", "#80493C","#33a02c","#e1d5c4", "#075C07","#542519", "yellow"), name="Lifestyle" ) + 
  
  theme_minimal() 
 

 
pmk1_hmap <- lifestyle_info |> 
  dplyr::select(name, dplyr::starts_with("Pmk1")) |> 
  tidyr::pivot_longer(-name, names_to = "PMK1", values_to = "required") |>
    dplyr::filter( name !="M.oryzae") |> 
  dplyr::mutate(
      required = dplyr::if_else(required, "Required", "Not Required"), 
      name = factor(name, level=rev(species_order)),
  ) |> 
  ggplot() + 
  aes(PMK1, name) +
  geom_tile(aes(fill=required)) +
  scale_fill_manual(values =  c("white", "red"), name="PMK1" ) + 
  
  theme_minimal()



```


Now we need the extra-cluster info as a wide heatmap

```{r}
 e_cluster_info <- readr::read_csv(here::here("results/counts_in_outside_clusters.csv")) |>
   dplyr::select(cluster_number, dplyr::starts_with("prop")) |> 
   tidyr::pivot_longer(-cluster_number, names_to = "cluster", values_to = "proportion") |> 
   dplyr::mutate(
     cluster_number = factor(cluster_number, level=rev(cluster_order)),
     ext_cluster = dplyr::if_else(
       cluster == "prop_in_clus1", "V", dplyr::if_else(
         cluster == "prop_in_clus3", "II", "III"
       )
     )
   ) |> 
  ggplot() +
  aes(cluster_number, ext_cluster) +
  geom_tile(aes(fill = proportion)) + 
  scale_fill_viridis_c(option = "B", name="Proportion", direction = -1) + 
  theme_minimal()

e_cluster_info
```

Now the trees.

```{r}
library(ape)
library(dendextend)
source(here::here("src/helpers.R"))

hmap_tree <- readRDS(here::here("results", "heatmap_species_dendro.RDS")) |> 
  as.phylo()

orthof_tree <- read.tree(here::here("results", "SpeciesTree_rooted.txt"))

info <- readr::read_csv(here::here("lib", "all_proteomes_lifestyles.csv")) |> 
  dplyr::select(name, tag)

info_vec <- info$name
names(info_vec) <- info$tag

for (i in 1:length(orthof_tree$tip.label)) {
  orthof_tree$tip.label[i] <- info_vec[orthof_tree$tip.label[i]]
}



library(ggtree)
library(ggtreeExtra)
library(tidytree)

nodes_absent <- get_nodes_different(hmap_tree, orthof_tree)

na_hmap <- as_tibble(hmap_tree) |> 
  mutate(not_in_orthof = node %in% nodes_absent$x) 


hmap_gg <- ggtree(hmap_tree,ladderize=FALSE) + 
  geom_tiplab(as_ylab = TRUE) + 
  geom_point2(aes(subset= na_hmap$not_in_orthof), colour="steelblue", fill="steelblue") 
hmap_gg <- rotate(hmap_gg, 42) + geom_tiplab(as_ylab = TRUE,face='italic') 
hmap_gg

na_orthof <- as_tibble(orthof_tree) |> 
  mutate(not_in_hmap = node %in% nodes_absent$y)


orthof_gg <- ggtree(orthof_tree, ladderize=FALSE) + geom_tiplab(as_ylab = TRUE,face="italic") + 
  geom_point2(aes(subset= na_orthof$not_in_hmap), colour="goldenrod", fill="goldenrod")

```
Now we can combine

```{r, fig.width=12, fig.height=12}
library(cowplot)
#library(patchwork)
clean <- theme(axis.text.y = element_blank(),
               axis.ticks.y = element_blank(),
               axis.title.y = element_blank(),
               legend.position = 'none',
               plot.margin = unit(c(0,0,0,0), "cm")
               )

no_x_tick <- theme(axis.text.x = element_blank(),
                   axis.title.x = element_text(angle = 90, vjust = 0, hjust=0, margin = unit(c(0,0,0,0), units = "cm"))
                   )
no_x_title <- theme(axis.title.x = element_blank())

null_x_title <- theme(axis.title.x = element_text())

top_opts <- theme(axis.title.x = element_blank(),
                  axis.text.x = element_blank(),
                  axis.text.y = element_blank(),
                  axis.title.y = element_blank(),
                  legend.position = 'none',
                  plot.margin = unit(c(0,0,0,0), "cm")
)

p1 <- plot_grid(
          hmap_gg + null_x_title, 
          life_hmap + clean + no_x_tick, 
          app_hmap + clean + no_x_tick, 
          pmk1_hmap + clean + no_x_tick, 
          hmap + clean + no_x_title, nrow=1,
          align = 'h',
          rel_widths = c(0.3, 0.03,0.03,0.03, 0.61)
          )



##this is a dirty hack, the top heatmap legends are not visible if we want the data aligned, so this is another version of the same heatmap but with the margins fudged so the heatmap doesnt show...

# Frank decided to leave this out

# e_clus_labs <- e_cluster_info + top_opts + theme(
#   axis.text.y = element_text(),
#   plot.margin = unit(c(0,0.7,0,0),"cm")
#   
# )
# 
# p2 <- plot_grid(
#   NULL, e_clus_labs, e_cluster_info + top_opts,
#   nrow = 1,
#   rel_widths = c(0.36, 0.03, 0.61)
# )
# 
# 
# p3<- plot_grid(p2,p1, rel_heights = c(0.1,0.9), ncol=1, align="hv")


p4 <- plot_grid(p1, orthof_gg, nrow = 1, rel_widths = c(0.8, 0.2))



l_lg <- get_legend(life_hmap + theme(legend.justification = c(1,1)))
app_lg <- get_legend(app_hmap+ theme(legend.justification = c(1,1)))
pmk1_lg <- get_legend(pmk1_hmap+ theme(legend.justification = c(1,1)))
hmap_lg <- get_legend(hmap + theme(legend.direction = "horizontal", legend.justification = c(0,0)))
#ec_lg <- get_legend(e_cluster_info + theme(legend.direction = "horizontal",legend.justification = c(0.6,1))) 

p5 <- plot_grid(
  l_lg,
  app_lg,
  pmk1_lg,
  nrow=1, align='h'
)

#p6 <- plot_grid(hmap_lg,  ec_lg, ncol=1, align='v')

p7 <- plot_grid(p5,hmap_lg, nrow=1, rel_widths = c(0.6,0.4))
final <- plot_grid(p4, p7, nrow=2, ncol=1, rel_heights = c(0.7, 0.3))
```

Now save...

```{r}
cowplot::save_plot(here::here("results/conservation_plot2.svg"), final, base_width=11.7, base_height=8.3)
cowplot::save_plot(here::here("results/conservation_plot2.png"), final, base_width=11.7, base_height=8.3, dpi=320, bg="white")
```


